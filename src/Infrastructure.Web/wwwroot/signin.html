<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion - BrokerX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, Arial; background: #f8f9fa; }
    .card { border-radius: 15px; border: none; box-shadow: 0 8px 25px rgba(0,0,0,.1); }
    .otp-input { 
      width: 50px; height: 50px; text-align: center; font-size: 20px; font-weight: bold;
      border: 2px solid #dee2e6; border-radius: 8px; 
    }
    .otp-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,.25); }
    .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; }
    .step { 
      width: 40px; height: 40px; border-radius: 50%; display: flex; 
      align-items: center; justify-content: center; margin: 0 10px; font-weight: bold;
    }
    .step.active { background: #007bff; color: white; }
    .step.inactive { background: #e9ecef; color: #6c757d; }
    .step-line { flex: 1; height: 2px; background: #e9ecef; margin: 0 10px; }
    .step-line.active { background: #007bff; }
    .dev-info { 
      background: #f8f9fa; border-left: 4px solid #007bff; 
      padding: 15px; margin: 20px 0; border-radius: 5px; 
    }
    .card-header { background: linear-gradient(135deg, #007bff, #0056b3); }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div id="msg" class="mb-3"></div>
        <div class="step-indicator mb-4">
          <div class="step active" id="step1">1</div>
          <div class="step-line" id="line1"></div>
          <div class="step inactive" id="step2">2</div>
        </div>
        <div id="loginForm" class="card shadow">
          <div class="card-header text-white text-center">
            <h4 class="mb-0"><i class="fas fa-sign-in-alt"></i> Connexion</h4>
          </div>
          <div class="card-body">
            <form id="login">
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" name="email" id="email" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Mot de passe</label>
                <input type="password" class="form-control" name="password" id="password" required>
              </div>
                              <div class="row">
                    <div class="col-md-8">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-outline-warning w-100" id="bypassMfaBtn">
                            <i class="fas fa-fast-forward"></i> Skip MFA
                        </button>
                    </div>
                </div>
            </form>
            <hr>
            <div class="text-center">
              <small class="text-muted">Pas encore de compte ?</small><br>
              <a href="/signup" class="btn btn-outline-primary btn-sm mt-2">
                <i class="fas fa-user-plus"></i> Créer un compte
              </a>
            </div>
          </div>
        </div>
        <div id="mfaForm" class="card shadow" style="display: none;">
          <div class="card-header bg-warning text-dark text-center">
            <h4 class="mb-0"><i class="fas fa-shield-alt"></i> Authentification 2FA</h4>
          </div>
          <div class="card-body text-center">
            <div class="mb-4">
              <i class="fas fa-mobile-alt fa-3x text-warning mb-3"></i>
              <h5>Code d'authentification requis</h5>
              <p class="text-muted">Entrez le code à 6 chiffres reçu par email</p>
            </div>
            <form id="mfa">
              <input type="hidden" name="clientId" id="mfaClientId">
              <input type="hidden" name="challengeId" id="mfaChallengeId">
              <div class="mb-4">
                <div class="d-flex justify-content-center gap-2">
                  <input type="text" class="otp-input" maxlength="1" id="mfa1" autocomplete="off">
                  <input type="text" class="otp-input" maxlength="1" id="mfa2" autocomplete="off">
                  <input type="text" class="otp-input" maxlength="1" id="mfa3" autocomplete="off">
                  <input type="text" class="otp-input" maxlength="1" id="mfa4" autocomplete="off">
                  <input type="text" class="otp-input" maxlength="1" id="mfa5" autocomplete="off">
                  <input type="text" class="otp-input" maxlength="1" id="mfa6" autocomplete="off">
                </div>
                <input type="hidden" name="code" id="mfaCode">
              </div>
              <button type="submit" class="btn btn-warning btn-lg w-100 mb-3">
                <i class="fas fa-check"></i> Vérifier le code
              </button>
            </form>
            <div class="dev-info">
              <h6><i class="fas fa-code"></i> Mode développement</h6>
              <p class="mb-1"><strong>Code disponible via :</strong></p>
              <ul class="mb-1 text-start">
                <li>Console navigateur → Logs</li>
                <li>GET /api/v1/auth/debug/mfa/{clientId}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const mfaForm = document.getElementById('mfaForm');
    const login = document.getElementById('login');
    const mfa = document.getElementById('mfa');
    const msg = document.getElementById('msg');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const line1 = document.getElementById('line1');
    const otpInputs = document.querySelectorAll('.otp-input');

    // Mode debug si ?debug=1 dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const debugMode = urlParams.get('debug') === '1';

    if (debugMode) {
      document.title += ' [DEBUG MODE]';
      document.body.style.borderTop = '5px solid orange';
    }

    // Gestionnaire pour le bouton bypass MFA
    document.getElementById('bypassMfaBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      msg.innerHTML = '';
      
      const payload = { 
        email: login.email.value, 
        password: login.password.value 
      };
      
      try {
        const res = await fetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Forwarded-For': 'bypass',  // Signal pour bypasser le MFA
            'User-Agent': 'bypass'        // Signal pour bypasser le MFA
          },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.token) {
          localStorage.setItem('authToken', data.token);
          msg.innerHTML = '<div class="alert alert-warning"><i class="fas fa-fast-forward"></i> MFA bypassé - Connecté directement!</div>';
          
          setTimeout(() => {
            window.location.href = '/dashboard.html';
          }, 1500);
        } else {
          msg.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> Erreur lors du bypass</div>';
        }
      } catch (err) {
        msg.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> Erreur réseau</div>';
      }
    });

    login.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.innerHTML = '';
      
      const payload = { 
        email: login.email.value, 
        password: login.password.value 
      };
      
      try {
        const res = await fetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.mfaRequired) {
          msg.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> MFA requis</div>';
          
          if (data.clientId) document.getElementById('mfaClientId').value = data.clientId;
          if (data.challengeId) document.getElementById('mfaChallengeId').value = data.challengeId;
          
          if (debugMode && data.clientId && data.challengeId) {
            msg.innerHTML += `<div class="alert alert-warning mt-2"><strong>DEBUG MFA:</strong><br>ClientId: <code>${data.clientId}</code><br>ChallengeId: <code>${data.challengeId}</code></div>`;
          }
          
          loginForm.style.display = 'none';
          mfaForm.style.display = 'block';
          step1.classList.remove('active');
          step1.classList.add('inactive');
          step2.classList.remove('inactive');
          step2.classList.add('active');
          line1.classList.add('active');
          
          otpInputs[0].focus();
          
        } else if (data.token) {
          // Stocker le token pour les futures requêtes API
          localStorage.setItem('authToken', data.token);
          
          msg.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Connecté !</div>';
          
          if (debugMode) {
            msg.innerHTML += `<div class="alert alert-info mt-2"><strong>DEBUG:</strong><br>Token: <code>${data.token}</code></div>`;
            setTimeout(() => {
              if (confirm('Mode debug - Rester sur cette page ?')) return;
              window.location.href = '/dashboard';
            }, 3000);
          } else {
            setTimeout(() => window.location.href = '/dashboard', 1500);
          }
        } else {
          msg.innerHTML = '<div class="alert alert-danger">Erreur: ' + (data.message || 'Connexion échouée') + '</div>';
        }
      } catch (error) {
        msg.innerHTML = '<div class="alert alert-danger">Erreur réseau</div>';
      }
    });

    mfa.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.innerHTML = '';
      
      const payload = {
        clientId: document.getElementById('mfaClientId').value,
        challengeId: document.getElementById('mfaChallengeId').value,
        code: document.getElementById('mfaCode').value
      };
      
      if (payload.code.length !== 6) {
        msg.innerHTML = '<div class="alert alert-warning">Entrez les 6 chiffres</div>';
        return;
      }
      
      try {
        const res = await fetch('/api/v1/auth/mfa/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.token) {
          // Stocker le token pour les futures requêtes API
          localStorage.setItem('authToken', data.token);
          
          msg.innerHTML = '<div class="alert alert-success">Authentifié !</div>';
          
          if (debugMode) {
            msg.innerHTML += `<div class="alert alert-info mt-2"><strong>DEBUG:</strong><br>Token: <code>${data.token}</code></div>`;
            setTimeout(() => {
              if (confirm('Mode debug - Rester sur cette page ?')) return;
              window.location.href = '/dashboard';
            }, 3000);
          } else {
            setTimeout(() => window.location.href = '/dashboard', 1500);
          }
        } else {
          msg.innerHTML = '<div class="alert alert-danger">Code invalide</div>';
        }
      } catch (error) {
        msg.innerHTML = '<div class="alert alert-danger">Erreur vérification</div>';
      }
    });

    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        if (e.target.value && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }
        updateCombinedCode();
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });
    });

    function updateCombinedCode() {
      const code = Array.from(otpInputs).map(input => input.value).join('');
      document.getElementById('mfaCode').value = code;
    }
  </script>
</body>
</html>
